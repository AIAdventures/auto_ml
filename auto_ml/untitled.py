import datetime
import math
bad1 = [{'order_protocol_fax': 1, 'created_at_in_local_time': datetime.datetime(2016, 7, 30, 8, 38, 34, 64007), 'max_80_percentile_category_prep_time': 1918L, 'avg_median_category_prep_time': '1652.0', 'max_20_percentile_category_prep_time': 1229L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 7L, 'preference_level': 1L, 'num_categories_with_low_prev_order_count': 0L, 'avg_num_orders_category_appearing_in': 55L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': None, 'submarket_id': 1, 'store_starting_point_id': 17, 'is_automated': 1, 'total_items_in_order': 20L, 'order_protocol_dasher_place': None, 'max_original_item_price': 1050, 'composite_score': 4.47359648948567, 'is_partner': 1, 'avg_median_item_prep_time': None, 'subpredictor_y_order_place_duration': 32L, 'max_80_percentile_item_prep_time': None, 'price_range': 2L, 'subtotal': 1050L, 'order_protocol_ipad': None, 'num_items_with_low_prev_order_count': 20L, 'direct_r2c_est_duration': 620, 'district_id': 99, 'subpredictor_y_prep_time_duration': 739L, 'order_protocol_phone': None, 'market_id': 2, 'min_original_item_price': 1050, 'flf': 0.9}, {'order_protocol_fax': 1, 'created_at_in_local_time': datetime.datetime(2016, 7, 22, 16, 35, 9, 385790), 'max_80_percentile_category_prep_time': 1606L, 'avg_median_category_prep_time': '1255.7', 'max_20_percentile_category_prep_time': 874L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 122L, 'preference_level': 1L, 'num_categories_with_low_prev_order_count': 0L, 'avg_num_orders_category_appearing_in': 1162L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': 845L, 'submarket_id': 2, 'store_starting_point_id': 70, 'is_automated': 1, 'total_items_in_order': 40L, 'order_protocol_dasher_place': None, 'max_original_item_price': 749, 'composite_score': 4.56535168293708, 'is_partner': 1, 'avg_median_item_prep_time': '1254.0', 'subpredictor_y_order_place_duration': 59L, 'max_80_percentile_item_prep_time': 1620L, 'price_range': 1L, 'subtotal': 1248L, 'order_protocol_ipad': None, 'num_items_with_low_prev_order_count': 0L, 'direct_r2c_est_duration': 750, 'district_id': 9, 'subpredictor_y_prep_time_duration': 1396L, 'order_protocol_phone': None, 'market_id': 1, 'min_original_item_price': 499, 'flf': 1.4}, {'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 7, 27, 13, 50, 10, 305847), 'max_80_percentile_category_prep_time': 2281L, 'avg_median_category_prep_time': '1708.0', 'max_20_percentile_category_prep_time': 1574L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 7L, 'preference_level': 1L, 'num_categories_with_low_prev_order_count': 13L, 'avg_num_orders_category_appearing_in': 19L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': None, 'submarket_id': 27, 'store_starting_point_id': 225, 'is_automated': 1, 'total_items_in_order': 26L, 'order_protocol_dasher_place': None, 'max_original_item_price': 1495, 'composite_score': 4.62169937001271, 'is_partner': 1, 'avg_median_item_prep_time': None, 'subpredictor_y_order_place_duration': 53L, 'max_80_percentile_item_prep_time': None, 'price_range': 2L, 'subtotal': 2040L, 'order_protocol_ipad': 1, 'num_items_with_low_prev_order_count': 26L, 'direct_r2c_est_duration': 540, 'district_id': 643, 'subpredictor_y_prep_time_duration': 994L, 'order_protocol_phone': None, 'market_id': 19, 'min_original_item_price': 1150, 'flf': 0.6}]

bad2 = [{'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 7, 16, 18, 14, 39, 888571), 'max_80_percentile_category_prep_time': 2133L, 'avg_median_category_prep_time': '1761.4', 'max_20_percentile_category_prep_time': 1485L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 6L, 'preference_level': 0L, 'num_categories_with_low_prev_order_count': 48L, 'avg_num_orders_category_appearing_in': 29L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': None, 'submarket_id': 4, 'store_starting_point_id': 16, 'is_automated': 1, 'total_items_in_order': 144L, 'order_protocol_dasher_place': None, 'max_original_item_price': 2499, 'composite_score': 3.90041630240156, 'is_partner': 0, 'avg_median_item_prep_time': None, 'subpredictor_y_order_place_duration': 201L, 'max_80_percentile_item_prep_time': None, 'price_range': 3L, 'subtotal': 13591L, 'order_protocol_ipad': None, 'num_items_with_low_prev_order_count': 128L, 'direct_r2c_est_duration': 835, 'district_id': 59, 'subpredictor_y_prep_time_duration': 2774L, 'order_protocol_phone': 1, 'market_id': 4, 'min_original_item_price': 799, 'flf': 1.5}, {'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 7, 21, 19, 5, 57, 358230), 'max_80_percentile_category_prep_time': 1918L, 'avg_median_category_prep_time': '1524.0', 'max_20_percentile_category_prep_time': 1056L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 100L, 'preference_level': 1L, 'num_categories_with_low_prev_order_count': 0L, 'avg_num_orders_category_appearing_in': 3053L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': 1066L, 'submarket_id': 33, 'store_starting_point_id': 300, 'is_automated': 0, 'total_items_in_order': 19L, 'order_protocol_dasher_place': None, 'max_original_item_price': 795, 'composite_score': 4.3, 'is_partner': 1, 'avg_median_item_prep_time': '1509.5', 'subpredictor_y_order_place_duration': 18L, 'max_80_percentile_item_prep_time': 1735L, 'price_range': 2L, 'subtotal': 795L, 'order_protocol_ipad': 1, 'num_items_with_low_prev_order_count': 0L, 'direct_r2c_est_duration': 522, 'district_id': None, 'subpredictor_y_prep_time_duration': 1753L, 'order_protocol_phone': None, 'market_id': 1, 'min_original_item_price': 795, 'flf': 0.6}, {'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 7, 31, 17, 36, 20, 988905), 'max_80_percentile_category_prep_time': 2389L, 'avg_median_category_prep_time': '1942.0', 'max_20_percentile_category_prep_time': 1407L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 63L, 'preference_level': 1L, 'num_categories_with_low_prev_order_count': 0L, 'avg_num_orders_category_appearing_in': 406L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': 1424L, 'submarket_id': 10, 'store_starting_point_id': 81, 'is_automated': 1, 'total_items_in_order': 84L, 'order_protocol_dasher_place': None, 'max_original_item_price': 275, 'composite_score': 4.68847223635251, 'is_partner': 1, 'avg_median_item_prep_time': '1942.0', 'subpredictor_y_order_place_duration': 50L, 'max_80_percentile_item_prep_time': 2416L, 'price_range': 1L, 'subtotal': 825L, 'order_protocol_ipad': 1, 'num_items_with_low_prev_order_count': 0L, 'direct_r2c_est_duration': 656, 'district_id': 744, 'subpredictor_y_prep_time_duration': 2210L, 'order_protocol_phone': None, 'market_id': 1, 'min_original_item_price': 275, 'flf': 1.1}]

good1 = [{'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 7, 16, 18, 14, 39, 888571), 'max_80_percentile_category_prep_time': 2133L, 'avg_median_category_prep_time': '1761.4', 'max_20_percentile_category_prep_time': 1485L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 6L, 'preference_level': 0L, 'num_categories_with_low_prev_order_count': 48L, 'avg_num_orders_category_appearing_in': 29L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': None, 'submarket_id': 4, 'store_starting_point_id': 16, 'is_automated': 1, 'total_items_in_order': 144L, 'order_protocol_dasher_place': None, 'max_original_item_price': 2499, 'composite_score': 3.90041630240156, 'is_partner': 0, 'avg_median_item_prep_time': None, 'max_80_percentile_item_prep_time': None, 'price_range': 3L, 'subtotal': 13591L, 'order_protocol_ipad': None, 'num_items_with_low_prev_order_count': 128L, 'direct_r2c_est_duration': 835, 'district_id': 59, 'order_protocol_phone': 1, 'market_id': 4, 'min_original_item_price': 799, 'flf': 1.5}, {'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 7, 21, 19, 5, 57, 358230), 'max_80_percentile_category_prep_time': 1918L, 'avg_median_category_prep_time': '1524.0', 'max_20_percentile_category_prep_time': 1056L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 100L, 'preference_level': 1L, 'num_categories_with_low_prev_order_count': 0L, 'avg_num_orders_category_appearing_in': 3053L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': 1066L, 'submarket_id': 33, 'store_starting_point_id': 300, 'is_automated': 0, 'total_items_in_order': 19L, 'order_protocol_dasher_place': None, 'max_original_item_price': 795, 'composite_score': 4.3, 'is_partner': 1, 'avg_median_item_prep_time': '1509.5', 'max_80_percentile_item_prep_time': 1735L, 'price_range': 2L, 'subtotal': 795L, 'order_protocol_ipad': 1, 'num_items_with_low_prev_order_count': 0L, 'direct_r2c_est_duration': 522, 'district_id': None, 'order_protocol_phone': None, 'market_id': 1, 'min_original_item_price': 795, 'flf': 0.6}, {'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 7, 31, 17, 36, 20, 988905), 'max_80_percentile_category_prep_time': 2389L, 'avg_median_category_prep_time': '1942.0', 'max_20_percentile_category_prep_time': 1407L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 63L, 'preference_level': 1L, 'num_categories_with_low_prev_order_count': 0L, 'avg_num_orders_category_appearing_in': 406L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': 1424L, 'submarket_id': 10, 'store_starting_point_id': 81, 'is_automated': 1, 'total_items_in_order': 84L, 'order_protocol_dasher_place': None, 'max_original_item_price': 275, 'composite_score': 4.68847223635251, 'is_partner': 1, 'avg_median_item_prep_time': '1942.0', 'max_80_percentile_item_prep_time': 2416L, 'price_range': 1L, 'subtotal': 825L, 'order_protocol_ipad': 1, 'num_items_with_low_prev_order_count': 0L, 'direct_r2c_est_duration': 656, 'district_id': 744, 'order_protocol_phone': None, 'market_id': 1, 'min_original_item_price': 275, 'flf': 1.1}]

good2 = [{'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 8, 3, 23, 22, 54, 715272), 'max_80_percentile_category_prep_time': 696L, 'avg_median_category_prep_time': '384.0', 'max_20_percentile_category_prep_time': 242L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 50L, 'preference_level': 0L, 'num_categories_with_low_prev_order_count': 0L, 'avg_num_orders_category_appearing_in': 122L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': 179L, 'submarket_id': 10, 'order_protocol_dasher_place': 1, 'is_automated': 0, 'total_items_in_order': 13L, 'store_starting_point_id': 81, 'max_original_item_price': 199, 'composite_score': 3.99071621837345, 'is_partner': 0, 'avg_median_item_prep_time': '321.5', 'max_80_percentile_item_prep_time': 603L, 'price_range': 1L, 'subtotal': 269L, 'order_protocol_ipad': None, 'num_items_with_low_prev_order_count': 0L, 'direct_r2c_est_duration': 623, 'district_id': 216, 'order_protocol_phone': None, 'market_id': 1, 'min_original_item_price': 199, 'flf': 0.9}, {'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 8, 1, 0, 15, 47, 146082), 'max_80_percentile_category_prep_time': 939L, 'avg_median_category_prep_time': '436.0', 'max_20_percentile_category_prep_time': 204L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 97L, 'preference_level': 0L, 'num_categories_with_low_prev_order_count': 0L, 'avg_num_orders_category_appearing_in': 833L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': 248L, 'submarket_id': 1, 'order_protocol_dasher_place': 1, 'is_automated': 0, 'total_items_in_order': 31L, 'store_starting_point_id': 11, 'max_original_item_price': 555, 'composite_score': 2.61575391078514, 'is_partner': 0, 'avg_median_item_prep_time': '480.5', 'max_80_percentile_item_prep_time': 867L, 'price_range': 1L, 'subtotal': 555L, 'order_protocol_ipad': None, 'num_items_with_low_prev_order_count': 0L, 'direct_r2c_est_duration': 565, 'district_id': 4, 'order_protocol_phone': None, 'market_id': 2, 'min_original_item_price': 555, 'flf': 1.0}, {'order_protocol_fax': None, 'created_at_in_local_time': datetime.datetime(2016, 8, 12, 20, 37, 40, 814911), 'max_80_percentile_category_prep_time': 1507L, 'avg_median_category_prep_time': '1257.5', 'max_20_percentile_category_prep_time': 850L, 'order_protocol_email': None, 'avg_num_orders_item_appearing_in': 4L, 'preference_level': 0L, 'num_categories_with_low_prev_order_count': 19L, 'avg_num_orders_category_appearing_in': 22L, 'order_protocol_online_order': None, 'max_20_percentile_item_prep_time': None, 'submarket_id': 16, 'order_protocol_dasher_place': None, 'is_automated': 1, 'total_items_in_order': 38L, 'store_starting_point_id': 236, 'max_original_item_price': 1975, 'composite_score': 4.14893641490105, 'is_partner': 0, 'avg_median_item_prep_time': None, 'max_80_percentile_item_prep_time': None, 'price_range': 2L, 'subtotal': 3025L, 'order_protocol_ipad': None, 'num_items_with_low_prev_order_count': 38L, 'direct_r2c_est_duration': 544, 'district_id': 377, 'order_protocol_phone': 1, 'market_id': 2, 'min_original_item_price': 1050, 'flf': 2.0}]

bad_attributes = {}

for row in bad1 + bad2:
    for key in row:
        bad_attributes[key] = True

good_attributes = {}
for row in good1 + good2:
    for key in row:
        good_attributes[key] = True


bad_keys = [key for key in bad_attributes]
good_keys = [key for key in good_attributes]

print('bad_keys')
print(bad_keys)
print(len(bad_keys))

print('good_keys')
print(good_keys)
print(len(good_keys))

idea:
    maybe i'm not passing through all the values to .predict. maybe my data cleaning is deleting some rows, and thus, it's appending the right predictions to the wrong rows, which would really throw off the final overall estimator.

try setting n_jobs=-1 for FeatureUnion
investigate the sparse matrix we return from AddSubpredictorPrediction